<?php
$host = "localhost";
$dbname = "{{ app_db_name }}";
$user = "{{ app_db_user }}";
$pass = "{{ app_db_password }}";

try {
    $dsn = "mysql:host=$host;dbname=$dbname;charset=utf8mb4";
    $pdo = new PDO($dsn, $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $pdo->exec("CREATE TABLE IF NOT EXISTS messages (
        id INT AUTO_INCREMENT PRIMARY KEY,
        content VARCHAR(255) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )");

    if (!empty($_POST['content'])) {
        $stmt = $pdo->prepare("INSERT INTO messages (content) VALUES (:content)");
        $stmt->execute(['content' => $_POST['content']]);
    }

    $stmt = $pdo->query("SELECT id, content, created_at FROM messages ORDER BY id DESC");
    $messages = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    die("Erreur de connexion Ã  la base : " . $e->getMessage());
}
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mini app PHP / MariaDB</title>
</head>
<body>
    <h1>Mini app PHP / MariaDB</h1>

    <form method="post">
        <input type="text" name="content" placeholder="Ton message" required>
        <button type="submit">Envoyer</button>
    </form>

    <h2>Messages</h2>
    <ul>
        <?php foreach ($messages as $msg): ?>
            <li>[<?= htmlspecialchars($msg['created_at']) ?>] <?= htmlspecialchars($msg['content']) ?></li>
        <?php endforeach; ?>
    </ul>
</body>
</html>
